<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>너의 이름은 - 교실 3D 뷰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; background:#111; }
    #popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      border-radius: 12px;
      display: none;
      z-index: 100;
    }
    #popup img {
      max-width: 90vw;
      max-height: 80vh;
    }
  </style>
</head>
<body>
<div id="popup"><img id="popupImg" src=""></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x101014);
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 2000);
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.HemisphereLight(0xffffff, 0x202028, 0.8));
const dir = new THREE.DirectionalLight(0xffffff, 0.9);
dir.position.set(10, 20, 10);
scene.add(dir);

const classroom = new THREE.Group();
scene.add(classroom);

const FLOOR_W = 72, FLOOR_H = 48;
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(FLOOR_W, FLOOR_H),
  new THREE.MeshStandardMaterial({ color:0x2a2a32 })
);
floor.rotation.x = -Math.PI/2;
classroom.add(floor);

const board = new THREE.Mesh(
  new THREE.PlaneGeometry(24, 6),
  new THREE.MeshStandardMaterial({ color:0x0f9d58 })
);
const BOARD_Z = -(FLOOR_H/2) + 2;
board.position.set(0, 6, BOARD_Z);
classroom.add(board);

function showImagePopup(src) {
  const popup = document.getElementById('popup');
  const img = document.getElementById('popupImg');
  img.src = src;
  popup.style.display = 'block';
}
document.getElementById('popup').onclick = () => {
  document.getElementById('popup').style.display = 'none';
};

function makeDeskCard(d, basePos) {
  const group = new THREE.Group();

  if (d.photo) {
    const tex = new THREE.TextureLoader().load(d.photo);
    const imgW = 3.2, imgH = 2.2;
    const photo = new THREE.Mesh(
      new THREE.PlaneGeometry(imgW, imgH),
      new THREE.MeshStandardMaterial({ map: tex, roughness: 1, metalness: 0, side: THREE.DoubleSide })
    );
    photo.position.set(basePos.x, basePos.y + 2.0, basePos.z);
    photo.callback = () => showImagePopup(d.photo);
    group.add(photo);

    const canvas = document.createElement('canvas');
    canvas.width = 512;
    canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = 'center';
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 32px sans-serif';
    ctx.fillText(d.name || '(빈자리)', canvas.width / 2, 70);
    ctx.font = '20px sans-serif';
    ctx.fillText(d.memo || '', canvas.width / 2, 110);

    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.LinearFilter;
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, transparent: true }));
    sprite.scale.set(3.2, 2.2, 1);
    sprite.position.set(basePos.x, basePos.y + 2.0, basePos.z + 0.01);
    group.add(sprite);
  }

  return group;
}

const sampleData = [{ name: '이름', memo: '메모는 작게', photo: 'https://i.imgur.com/CzXTtJV.png' }];
const deskW = 5, deskH = 3;
const desk = new THREE.Mesh(
  new THREE.BoxGeometry(deskW, 2.2, deskH),
  new THREE.MeshStandardMaterial({ color:0x7aa5ff })
);
desk.position.set(0, 1.1, 0);
classroom.add(desk);
const card = makeDeskCard(sampleData[0], desk.position);
classroom.add(card);

camera.position.set(0, 18, 26);
camera.lookAt(0, 5, 0);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
