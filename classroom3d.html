<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>교실 3D 보기</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background: #111;
      font-family: Arial, sans-serif;
    }
    #ui-box {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.25);
      width: min(90vw, 300px);
    }
    #ui-box h2 {
      font-size: 18px;
      margin: 0 0 12px;
    }
    #ui-box label {
      font-size: 14px;
      margin-top: 10px;
    }
    #ui-box input, #ui-box select, #ui-box button {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div id="ui-box">
  <h2>🎯 보기 설정</h2>
  <label>연도 선택</label>
  <input type="text" id="year" placeholder="예: 2025">

  <label>내 자리 번호</label>
  <input type="number" id="myIndex" placeholder="자리 번호 (1부터 시작)">

  <label>시점 모드</label>
  <select id="viewMode">
    <option value="third">3인칭 (뒤에서 보기)</option>
    <option value="first">1인칭 (내 자리에서 보기)</option>
  </select>

  <button onclick="loadClassroom()">교실 불러오기</button>
  <button onclick="goBack()">⬅ index.html로 돌아가기</button>
</div>
<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/examples/js/controls/OrbitControls.js"></script>
<script>
let scene, camera, renderer, controls;
let desks = [];

function goBack() {
  window.location.href = "index.html";
}

function initScene() {
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
  renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('canvas'), antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enablePan = false;
  controls.maxPolarAngle = Math.PI / 2.5;
  controls.minDistance = 150;
  controls.maxDistance = 500;

  const light = new THREE.AmbientLight(0xffffff, 1);
  scene.add(light);

  animate();
}

function loadClassroom() {
  const year = document.getElementById('year').value;
  const myIndex = parseInt(document.getElementById('myIndex').value) - 1;
  const mode = document.getElementById('viewMode').value;
  const rawData = localStorage.getItem(`seatData_${year}`);
  if (!rawData) {
    alert(`${year}년 데이터가 없습니다.`);
    return;
  }

  const seatData = JSON.parse(rawData);
  const cols = Math.ceil(Math.sqrt(seatData.length));
  const rows = Math.ceil(seatData.length / cols);

  initScene();

  const spacingX = 100, spacingY = 80;
  const offsetX = -((cols-1)*spacingX)/2;
  const offsetY = ((rows-1)*spacingY)/2;

  for (let i = 0; i < seatData.length; i++) {
    const data = seatData[i];
    const group = new THREE.Group();

    const desk = new THREE.Mesh(
      new THREE.BoxGeometry(80, 50, 10),
      new THREE.MeshBasicMaterial({ color: (data.name === '나') ? 0x99ccff : 0xdddddd })
    );
    group.add(desk);

    if (data.photo) {
      const texture = new THREE.TextureLoader().load(data.photo);
      const mesh = new THREE.Mesh(
        new THREE.PlaneGeometry(60, 60),
        new THREE.MeshBasicMaterial({ map: texture, transparent: true })
      );
      mesh.position.set(0, 30, 5);
      group.add(mesh);
    }

    const nameCanvas = document.createElement('canvas');
    nameCanvas.width = 256;
    nameCanvas.height = 64;
    const ctx = nameCanvas.getContext('2d');
    ctx.fillStyle = 'black';
    ctx.font = '16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(data.name, 128, 40);
    const nameTex = new THREE.CanvasTexture(nameCanvas);
    const nameMesh = new THREE.Mesh(
      new THREE.PlaneGeometry(60, 20),
      new THREE.MeshBasicMaterial({ map: nameTex, transparent: true })
    );
    nameMesh.position.set(0, 60, 5);
    group.add(nameMesh);

    if (data.memo) {
      const memoCanvas = document.createElement('canvas');
      memoCanvas.width = 256;
      memoCanvas.height = 64;
      const mctx = memoCanvas.getContext('2d');
      mctx.fillStyle = '#333';
      mctx.font = '12px Arial';
      mctx.textAlign = 'center';
      mctx.fillText(data.memo, 128, 40);
      const memoTex = new THREE.CanvasTexture(memoCanvas);
      const memoMesh = new THREE.Mesh(
        new THREE.PlaneGeometry(60, 20),
        new THREE.MeshBasicMaterial({ map: memoTex, transparent: true })
      );
      memoMesh.position.set(0, 45, 5);
      group.add(memoMesh);
    }

    const col = i % cols;
    const row = Math.floor(i / cols);
    group.position.set(offsetX + col * spacingX, 0, offsetY - row * spacingY);
    scene.add(group);
    desks.push(group);
  }

  // 카메라 시점 설정
  if (myIndex >= 0 && myIndex < desks.length) {
    const pos = desks[myIndex].position;
    if (mode === 'third') {
      camera.position.set(pos.x, 200, pos.z + 200);
    } else {
      camera.position.set(pos.x, 100, pos.z);
    }
    controls.target.set(pos.x, 0, pos.z);
    controls.update();
  }
}

function animate() {
  requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>
</body>
</html>
